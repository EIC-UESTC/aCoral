# aCoral C语言代码规范


| 版本 | 作者           | 日期       | 更新内容         |
| ------ | ---------------- | ------------ | ------------------ |
| v0.1 | 饶洪江、文佳源 | 2025-03-18 | 增写目的、原则、命名 |
| v0.2 | 饶洪江、文佳源 | 2025-03-19 | v0.1修改、增写排版格式 |

## <span id="goal">目的</span>

我们制定该规范的目的旨在提升代码质量、可维护性、协作效率、可移植性、安全性、可靠性，规范编码风格，确保代码清晰、易读、易维护，便于开发者理解和修改他人代码，便于知识传递。如果在团队运作中认为某个规则无法遵循，希望可以共同改进该规则。

## <span id="rule">原则</span>

代码需要在保证功能正确的前提下，满足规范的编码要求。

## <span id="1">1 命名</span>

命名包括文件、函数、变量、类型、宏等命名。

整体采用unix风格，即单词小写，用下划线分割， 如：'test_result'。

### <span id="1.1">1.1 标识符命名风格</span>


| 类型                                                                                     | 命名风格           |
| ------------------------------------------------------------------------------------------ | -------------------- |
| 函数，结构体类型，枚举类型，联合体类型变量，函数参数，宏参数，结构体中字段，联合体中成员 | 全小写，下划线分割 |
| 宏，常量，枚举值                                                                         | 全大写，下划线分割 |

**注意 1：** 对于单词的缩写，仅可使用约定俗成、被广泛使用的缩写，请勿随意自行进行缩写。不清楚该单词是否有惯用缩写时，使用完整单词。

**注意 2：** 与内核相关的函数名、类型、全局变量前需要加`acoral_`前缀。例：`acoral_ipc_sys_init`, `acoral_u8`, `acoral_ready_queues`

### <span id="1.2">1.2 文件命名</span>

文件名应尽量简短、准确、无二义性。

文件名命名只允许使用小写字母、数字以及下划线(_)。

好的命名举例：

`lwip_tcp_client.c`

### <span id="1.3">1.3 函数命名</span>

函数的命名遵循一般阅读习惯，动作类函数名，可以使用动宾或者主谓结构；

例：`acoral_mem_scan`, `acoral_get_ticks`

判断型函数，可以用形容词，或加 is。

例：`is_connected`, `data_ready`

### <span id="1.4">1.4 变量命名</span>

**除计数变量，所有变量命名均应该能够表达其含义、作用。**

变量命名使用unix风格，包括全局变量，局部变量，函数声明或定义中的参数，带括号宏中的参数。

与内核无关的全局变量需要增加`g_`前缀，与内核相关的全局变量需要增加`acoral_`前缀

函数局部变量的命名，在能够表达相关含义的前提下，应该尽量简短。

### <span id="1.5">1.5 类型命名</span>

定义结构体、联合体、枚举时均使用`typedef`，后缀加`_t`，且尽量使用匿名类型。左大括号需另起一行，右大括号与类型名间间隔一个空格。例：

```c
typedef struct
{
    acoral_u8 prio;优先级
    acoral_queue_t stack;局部资源系统栈
    acoral_queue_t wait;
} acoral_mpcp_system_t;

/* 特殊情况例外：必须加_acoral_mq_message */
typedef struct _acoral_mq_message
{
    struct _acoral_mq_message *next;
    acoral_size length;
} acoral_mq_message_t;
```

### <span id="1.6">1.6 宏、常量、枚举命名</span>

全大写，下划线分割

## <span id="2">2 排版格式</span>

### <span id="2.1">2.1 行宽</span>

行宽不能超过100个字符，不要在会导致内容截断的地方换行

### <span id="2.2">2.2 缩进</span>

使用空格进行缩进，每次缩进4个空格

### <span id="2.3">2.3 大括号</span>

除了<a href="#2.12">数组初始化</a>和<a href="#1.5">类型命名</a>外，所有左大括号和右大括号都另起一行放行首，并独占一行。

### <span id="2.4">2.4 函数声明与定义</span>

函数声明、定义的返回类型和函数名在同一行。

当行宽无法容纳所有参数或函数有3个及以上参数时，进行换行：

* 参数列表的左小括号总是和函数名在同一行，不要单独一行，且中间不要留空格；
* 其余参数缩进4个空格，并各自独占一行，以第一个非`*`字符对齐，参数类型与参数名间间距尽可能小；
* 右小括号另起一行放行首，并独占一行。

例：

```c
acoral_err acoral_mq_init(
    acoral_mq_t *mq, 
    void        *msg_buf, 
    acoral_size  buf_size, 
    acoral_size  msg_size
);
```

### <span id="2.5">2.5 函数调用</span>

要么一行写完函数调用, 要么在小括号里对参数分行，函数调用时函数名与左小括号必须在同一行且中间无空格。

在对参数进行分行时，第一个参数紧跟在左小括号之后，其余参数各占独占一行并与第一个参数对齐；右小括号另起一行与左小括号对齐，并紧跟分号。例：

```c
    acoral_create_thread(period_func_9,
                         1024,
                         NULL,
                         "period_func_9",
                         NULL,
                         ACORAL_SCHED_POLICY_PERIOD,
                         &period_policy_data[7],
                         NULL,
                         NULL
                        );
```

如果函数调用的参数存在内在关联性，按照可理解性优先于格式排版要求，对参数进行合理分组换行。参数的格式处理应当以可读性而非其他作为最重要的原则。例：

```c
matrix_transform(x1, x2, x3,
                 y1, y2, y3,
                 z1, z2, z3
                );
```

### <span id="2.6">2.6 条件语句</span>

条件语句必须要使用大括号，大括号的格式按照<a href="#2.3">2.3</a>。

`if`和左小括号间留一个空格。

```c
    if (condition)
    {
        /* code */
    }
```

### <span id="2.7">2.7 循环</span>

与条件语句类似循环体中仅有一条时，也必须要使用大括号，大括号的格式按照<a href="#2.3">2.3</a>。

`while`、`for`和左小括号间留一个空格。例：

```c
    while (condition)
    {
        /* code */
    }
```

但如果循环体为空，则不要使用大括号，在右小括号后紧跟`;`。例：

```c
    while(1);
```

### <span id="2.8">2.8 switch语句</span>

switch 语句的 case/default 要缩进一层。`switch`和左小括号间留一个空格，`switch`和条件间留一个空格。例：

```c
    switch (buf->time_unit)
    {
        case TIME_UNIT_US:
        {
            during *= 1000;
            break;
        }
        case TIME_UNIT_MS:
        {
            break;
        }
        default:
        {
            acoral_print("ERROR: unknown time unit\r\n");
            break;
        }
    }
```
### <span id="2.10">2.10 表达式</span>
较长的表达式，不满足行宽要求的时候，一般在较低优先级操作符或连接符后面截断，操作符或连接符放在行末，以表示“未结束，后续还有”。

换行后保持对齐。例：
```c
    int sum = long_variable_name_1 + long_variable_name2 + long_variable_name_3 +
              long_variable_name_4 + variable_name5 + variable_name_6;  
```
### <span id="2.11">2.11 变量赋值</span>
每行只有一个变量初始化的语句，更容易阅读和理解。

对于多个相关性强的变量定义，且无需初始化时，可以定义在一行，减少重复信息，以便代码更加紧凑。
### <span id="2.12">2.12 初始化</span>
初始化包括结构体、联合体及数组的初始化。结构体或数组初始化时，如果需要换行应在左大括号后开始换行并保持4空格缩进。例：
```c
    int arr[4] = { 1, 2, 3, 4 };
    const int rank[] = { 
        16, 16, 16, 16, 32, 32, 32, 32,
        64, 64, 64, 64, 32, 32, 32, 32
    };
    int array[][4] = {
        { 1, 2, 3, 4 }, { 2, 2, 3, 4 }, // OK.
        { 3, 2, 3, 4 }, { 4, 2, 3, 4 }
    };
    
    /* 指定初始化，每个成员的初始化单独一行*/
    typedef struct
    {
        int year;
        int month;
        int day;
    } Date;

    Date date = {    
        .year   = 2000,
        .month  = 1,
        .day    = 1 
    };
```
### <span id="2.13">2.13 指针</span>
指针类型`*`跟随变量名，`*`前留有空格；若存在无法跟随的情况时时就不跟随。例：
```c
    int *ptr;

    /* 无法跟随 */
    char * const VERSION = "V100";
    int foo(const char * restrict ptr);
```
**注意**：任何时候 `*` 不要紧跟 const 或 restrict 关键字。

### <span id="2.14">2.14 编译预处理</span>
编译预处理的"#"放在行首，嵌套编译预处理语句时，"#"不进行缩进，但需要在`#enfif`、`#else`、`#elif`处注释以标明其对应哪个`#if`。例：
```c
#if condition_1

#if condition_2

#elif condition_3 // if  condition_2

#else // if  condition_2

#endif // if condition_2

#endif // if condition_1
```
### <span id="2.15">2.15 空格和空行</span>
水平空格应该突出关键字和重要信息，每行代码尾部不要加空格。 总体规则如下：

* if, switch, case, do, while, for 等关键字之后加空格；
* 小括号内部的两侧，不要加空格
* 二元操作符（= + ‐ < > * / % | & ^ <= >= == !=）左右两侧加空格
* 一元操作符（& * + ‐ ~ !）之后不要加空格
* 三目操作符（? :）符号两侧均需要空格
* 结构体中表示位域的冒号，两侧均需要空格
* 前置和后置的自增、自减（++ --）和变量之间不加空格
* 结构体成员操作符（. ->）前后不加空格
* 逗号、分号、冒号（不含三目操作符和表示位域的冒号）紧跟前面内容无空格，其后需要空格
* 函数参数列表的小括号与函数名之间无空格
* 类型强制转换的小括号与被转换对象之间无空格
* 数组的中括号与数组名之间无空格
* 涉及到换行时，行末的空格可以省去

对于大括号内部两侧的空格，要求如下：

* 一般的，大括号内部两侧建议加空格
* 对于空的，或单个标识符，或单个字面常量，不加空格。

例：
```c
    int buf[BUF_SIZE] = {0};
    int arr[] = { 10, 20 };
```

合理安排空行，保持代码紧凑，减少不必要的空行，可以显示更多的代码，方便代码阅读。

* 根据上下内容的相关程度，合理安排空行；
* 函数内部、类型定义内部、宏内部、初始化表达式内部，不使用连续空行
* 不使用连续3个空行或更多
* 大括号内的代码块首行之前和末行之后不要加空行。